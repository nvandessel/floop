name: Test Release

on:
  pull_request:
    paths:
      - '.goreleaser.yml'
      - '.github/workflows/version-bump.yml'
      - '.github/workflows/test-release.yml'
      - 'scripts/generate_changelog.sh'
      - 'Makefile'
      - 'cmd/floop/main.go'
      - 'cmd/floop/cmd_version.go'

permissions:
  contents: read

env:
  GORELEASER_VERSION: v2.8.0

jobs:
  test-release:
    name: Test Release Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"

      - name: Validate changelog generator script
        run: bash -n scripts/generate_changelog.sh

      - name: Run GoReleaser in snapshot mode
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ${{ env.GORELEASER_VERSION }}
          args: build --snapshot --clean

      - name: Verify binaries
        run: |
          echo "Checking for built binaries..."
          ls -lh dist/*/

          # Test a Linux binary
          echo -e "\nTesting Linux amd64 binary..."
          ./dist/floop_linux_amd64_v1/floop version

      - name: Check archives
        run: |
          echo "Checking for expected files in archives..."
          # The build command doesn't create archives, but we can verify the structure
          if [ -d "dist/floop_linux_amd64_v1" ]; then
            echo "✅ Linux amd64 build found"
          fi
          if [ -d "dist/floop_linux_arm64" ]; then
            echo "✅ Linux arm64 build found"
          fi
          if [ -d "dist/floop_darwin_amd64_v1" ]; then
            echo "✅ macOS amd64 build found"
          fi
          if [ -d "dist/floop_darwin_arm64" ]; then
            echo "✅ macOS arm64 build found"
          fi
          if [ -d "dist/floop_windows_amd64_v1" ]; then
            echo "✅ Windows amd64 build found"
          fi
          if [ -d "dist/floop_windows_arm64" ]; then
            echo "✅ Windows arm64 build found"
          fi

      - name: Summary
        run: |
          echo "✅ GoReleaser build test passed" >> $GITHUB_STEP_SUMMARY
          echo "All platform binaries built successfully in snapshot mode" >> $GITHUB_STEP_SUMMARY
